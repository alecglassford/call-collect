<div>
  {{#if !currentSubmissions || !currentPrompts}}
    Loading submissions.
  {{else}}
    {{#each currentPrompts as prompt}}
      <h3>Submissions for prompt {{prompt.fields.index}}</h3>
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Caller</th>
            <th>Audio</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody>
          {{#each filterByPrompt(currentSubmissions, prompt.id) as submission}}
            <tr>
              <td class="timestamp">{{new Date(submission.fields.timestamp).toLocaleString()}}</td>
              <td class="caller">{{humanPhone(submission.fields.caller)}}</td>
              <!-- <td><audio controls preload="metadata" src="{{submission.fields.audio}}"></audio></td> -->
              <td class="audio">
                <span class="soundcite" data-url="{{submission.fields.audio}}" data-plays="1">
                  {{#if submission.fields.transcript}}
                    {{submission.fields.transcript}}
                  {{else}}
                    No transcript available.
                  {{/if}}
                </span>
              </td>
              <td class="download"><a href="{{submission.fields.audio}}.wav?Download=true">⬇️</a></td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    {{/each}}
  {{/if}}
</div>

<style>
  table {
    margin: 1em 0;
    width: 100%;
    border-collapse: collapse;
  }

  td {
    border: 1px solid grey;
    padding: 0.5em;
  }

  td:first-child {
    border-left: 0;
  }

  td:last-child {
    border-right: 0;
  }

  .timestamp {
    min-width: 8em;
  }

  .caller {
    min-width: 6em;
  }

  .audio {
    max-width: 20em;
  }

  .download a {
    text-decoration: none;
  }

  .soundcite {
    display: inline-block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .soundcite:hover {
    white-space: normal;
  }
</style>

<script>
  import initSoundcite from './soundcite';
  import { humanPhone } from './util';

  export default {
    oncreate() {
      this.observe('currentSubmissions', () => {
        initSoundcite();
      }, { defer: true });
    },
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        currentSubmissions: null,
      };
    },
    computed: {
      projectName: currentProject => currentProject.fields.name,
    },
    helpers: {
      filterByPrompt: (currentSubmissions, promptId) =>
        currentSubmissions.filter(sub => sub.fields.prompt[0] === promptId),
      humanPhone,
    },
  };
</script>
