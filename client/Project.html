<div>
  <ProjectInfo :currentProject :currentPrompts :currentSubmissions on:refreshPrompts="refreshPrompts(event)"/>
  <Submissions :currentProject :currentPrompts :currentSubmissions/>
</div>

<style>
  div {
    flex-grow: 1;
    background-color: #FBFCFC;
    padding: 1em;
    display: flex;
    flex-direction: column;
  }
</style>

<script>
  import ProjectInfo from './ProjectInfo.html';
  import Submissions from './Submissions.html';

  const fetchProject = function fetchProjectFunc() {
    const { slug } = this.get('match').params;
    return this.store.get('projectList').then((projects) => {
      const currentProject = projects.find(p => p.id === slug);
      this.set({ currentProject });
      return currentProject;
    });
  };

  const fetchPrompts = function fetchPromptsFunc() {
    const name = this.get('uriName');
    fetch(`/api/prompts/${name}`).then(res => res.json())
      .then((currentPrompts) => {
        this.set({ currentPrompts });
        this.set({ originalOrder: currentPrompts.map(p => p.id) });
      });
  };

  const fetchSubmissions = function fetchSubmissionsFunc() {
    const name = this.get('uriName');
    fetch(`/api/submissions/${name}`).then(res => res.json())
      .then((currentSubmissions) => {
        this.set({ currentSubmissions });
      });
  };

  export default {
    components: { ProjectInfo, Submissions },
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        originalOrder: null, // array of promptIds
        currentSubmissions: null,
      };
    },
    computed: {
      uriName: (currentProject) => {
        if (!currentProject || currentProject === 'new') return null;
        return encodeURIComponent(currentProject.fields.name);
      },
    },
    oncreate() {
      fetchProject.call(this).then(() => {
        fetchPrompts.call(this);
        fetchSubmissions.call(this);
      });
    },
    methods: {
      refreshPrompts(ev) {
        if (!ev.reorderedPrompts) {
          fetchPrompts.call(this);
          return;
        }
        const changed = [];
        const [old, reordered] = [this.get('originalOrder'), ev.reorderedPrompts];
        for (let i = 0; i < old.length; i += 1) {
          if (old[i] !== reordered[i].id) changed.push([reordered[i].id, i]);
        }
        const name = this.get('uriName');
        fetch(`/api/prompts/${name}`, {
          method: 'PUT',
          body: JSON.stringify(changed),
          headers: new Headers({ 'Content-Type': 'application/json' }),
        }).then(res => res.json()).then((currentPrompts) => {
          this.set({ currentPrompts });
          this.set({ originalOrder: currentPrompts.map(p => p.id) });
        });
      },
    },
  };
</script>
