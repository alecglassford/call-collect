{{#if currentProject}}
  <div id="project-info" class="row mx-auto">
    <div class="col-12 text-center">
      <h2 class="display-4 serif">{{name}}</h2>
      <h3>{{humanPhone(currentProject.fields.phone)}}</h3>
      {{#if currentProject.fields.description}}<p>{{currentProject.fields.description}}</p>{{/if}}
      {{#if currentSubmissions}}
      <p>This project has received {{currentSubmissions.length}} submissions.</p>
      {{/if}}
      {{#if !currentPrompts}}
        <Spinner/>
      {{else}}
        <div>
          {{#each currentPrompts as prompt, i}}
            <div class="row mt-3">
              <div class="reorder">
                <button on:click="up(i)">⬆️</button>
                {{#if i !== currentPrompts.length - 1}}<button on:click="down(i)">⬇️</button>{{/if}}
              </div>
              <h4 class="col-sm-6 text-left">
                {{#if prompt.fields.slug}}
                  {{prompt.fields.slug}}
                {{else}}
                  Prompt {{humanIndex(prompt.fields.index)}}
                {{/if}}
              </h4>
              <audio controls src="{{audioUrl(prompt)}}" class="col-sm-6"></audio>
            </div>
          {{/each}}
        </div>
        {{#if promptsChanged}}
          <button on:click="saveReorder()" class="btn btn-success mt-3">Save new prompt order</button>
        {{else}}
          <UploadPrompt projectId="{{currentProject.id}}" index="{{currentPrompts.length}}" on:refreshPrompts/>
        {{/if}}
      {{/if}}
    </div>
  </div>
{{/if}}

<style>
  #project-info {
    max-width: 720px;
  }

  /*** reorder buttons ***/

  .reorder {
    visibility:hidden;
    position: absolute;
    left: -1em;
  }

  div:hover > .reorder {
    visibility: visible;
  }

  .reorder button {
    display: block;
    border: none;
    outline: none;
    background-color: transparent;
    cursor: pointer;
    font-size: 0.5em;
  }

  /* hides up arrow for first prompt */
  div:first-child > .reorder > button:first-child {
    visibility: hidden;
  }
</style>

<script>
  import { humanIndex, humanPhone } from './util';
  import Spinner from './Spinner.html';
  import UploadPrompt from './UploadPrompt.html';

  export default {
    components: { Spinner, UploadPrompt },
    computed: {
      name: currentProject => (currentProject ? currentProject.fields.name : ''),
    },
    helpers: {
      audioUrl: prompt => prompt.fields.audio[0].url,
      humanIndex,
      humanPhone,
    },
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        currentSubmissions: null,
        promptsChanged: false,
      };
    },
    methods: {
      up(i) {
        const currentPrompts = this.get('currentPrompts');
        [currentPrompts[i - 1], currentPrompts[i]] = [currentPrompts[i], currentPrompts[i - 1]];
        this.set({ currentPrompts, promptsChanged: true });
      },
      down(i) {
        const currentPrompts = this.get('currentPrompts');
        [currentPrompts[i + 1], currentPrompts[i]] = [currentPrompts[i], currentPrompts[i + 1]];
        this.set({ currentPrompts, promptsChanged: true });
      },
      saveReorder() {
        // Tell parent to find differences and update with PUT request
        this.fire('refreshPrompts', { reorderedPrompts: this.get('currentPrompts') });
        // Spinner until parent confirms save
        this.set({ currentPrompts: null, promptsChanged: false });
      },
    },
  };
</script>
