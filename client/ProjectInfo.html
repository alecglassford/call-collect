{{#if currentProject}}
<div id="project-info">
  <h2>{{name}}</h2>
  <h3>{{humanPhone(currentProject.fields.phone)}}</h3>
  {{#if currentProject.fields.description}}<p>{{currentProject.fields.description}}</p>{{/if}}
  {{#if !currentPrompts}}
    <Spinner/>
  {{else}}
    <div id="prompts-container">
      {{#each currentPrompts as prompt, i}}
        <div>
          <div class="reorder">
            <button on:click="up(i)">⬆️</button>
            {{#if i !== currentPrompts.length - 1}}<button on:click="down(i)">⬇️</button>{{/if}}
          </div>
          <h4>
            {{#if prompt.fields.slug}}
              {{prompt.fields.slug}}
            {{else}}
              Prompt {{humanIndex(prompt.fields.index)}}
            {{/if}}
          </h4>
          <audio controls src="{{audioUrl(prompt)}}"></audio>
        </div>
      {{/each}}
      {{#if promptsChanged}}
        <button on:click="saveReorder()">Save new prompt order</button>
      {{else}}
        <UploadPrompt projectId="{{currentProject.id}}" index="{{currentPrompts.length}}" on:refreshPrompts/>
      {{/if}}
    </div>
  {{/if}}
  {{#if currentSubmissions}}
    <p>This project has received {{currentSubmissions.length}} submissions.</p>
  {{/if}}
</div>
{{/if}}

<style>
  #project-info {
    margin: 0 auto;
    text-align: center;
  }

  h2 {
    margin: 0;
    font-size: 2em;
    font-family: "Source Serif Pro", Palatino, Georgia, serif;
  }

  h3 {
    margin-top: 0.5em;
    font-size: 1.5em;
  }

  #prompts-container > div {
    margin: 1em 0;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-between;
    position: relative;
  }

  /*** reorder buttons ***/

  #prompts-container .reorder {
    visibility:hidden;
    position: absolute;
    left: -1em;
  }

  #prompts-container div:hover .reorder {
    visibility: visible;
  }

  .reorder button {
    display: block;
    border: none;
    outline: none;
    background-color: transparent;
    cursor: pointer;
    font-size: 0.5em;
  }

  /* hides up arrow for first prompt */
  div:first-child > .reorder > button:first-child {
    visibility: hidden;
  }

  /*** Other prompt ***/

  h4 {
    margin: 0 0.5em;
    font-size: 1.2em;
  }

  audio {
    max-width: 50%;
  }
</style>

<script>
  import { humanIndex, humanPhone } from './util';
  import Spinner from './Spinner.html';
  import UploadPrompt from './UploadPrompt.html';

  export default {
    components: { Spinner, UploadPrompt },
    computed: {
      name: currentProject => (currentProject ? currentProject.fields.name : ''),
    },
    helpers: {
      audioUrl: prompt => prompt.fields.audio[0].url,
      humanIndex,
      humanPhone,
    },
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        currentSubmissions: null,
        promptsChanged: false,
      };
    },
    methods: {
      up(i) {
        const currentPrompts = this.get('currentPrompts');
        [currentPrompts[i - 1], currentPrompts[i]] = [currentPrompts[i], currentPrompts[i - 1]];
        this.set({ currentPrompts, promptsChanged: true });
      },
      down(i) {
        const currentPrompts = this.get('currentPrompts');
        [currentPrompts[i + 1], currentPrompts[i]] = [currentPrompts[i], currentPrompts[i + 1]];
        this.set({ currentPrompts, promptsChanged: true });
      },
      saveReorder() {
        // Tell parent to find differences and update with PUT request
        this.fire('refreshPrompts', { reorderedPrompts: this.get('currentPrompts') });
        // Spinner until parent confirms save
        this.set({ currentPrompts: null, promptsChanged: false });
      },
    },
  };
</script>
