<div>
  {{#if !currentSubmissions || !currentPrompts}}
    Loading submissions.
  {{else}}
    {{#each currentPrompts as prompt}}
      <h3>Submissions for prompt {{prompt.fields.index}}</h3>
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Caller</th>
            <th>Audio</th>
          </tr>
        </thead>
        <tbody>
          {{#each filterByPrompt(currentSubmissions, prompt.id) as submission}}
            <tr>
              <td>{{submission.fields.timestamp}}</td>
              <td>{{submission.fields.caller}}</td>
              <!-- <td><audio controls preload="metadata" src="{{submission.fields.audio}}"></audio></td> -->
              <td class="audio">
                <span class="soundcite" data-url="{{submission.fields.audio}}" data-plays="1">
                  {{#if submission.fields.transcript}}
                    {{submission.fields.transcript}}
                  {{else}}
                    No transcript available.
                  {{/if}}
                </span>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    {{/each}}
  {{/if}}
</div>

<style>
  .audio {
    max-width: 25em;
  }

  .soundcite {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .soundcite:hover {
    white-space: normal;
  }
</style>

<script>
  import initSoundcite from './soundcite';

  export default {
    oncreate() {
      this.observe('currentSubmissions', () => {
        initSoundcite();
      }, { defer: true });
    },
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        currentSubmissions: null,
      };
    },
    computed: {
      projectName: currentProject => currentProject.fields.name,
    },
    helpers: {
      filterByPrompt: (currentSubmissions, promptId) =>
        currentSubmissions.filter(sub => sub.fields.prompt[0] === promptId),
    },
  };
</script>
