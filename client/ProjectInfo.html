{{#if currentProject}}
  <div id="project-info" class="row mx-auto">
    <div class="col-12 text-center">
      <h2 class="display-4 serif">{{name}}</h2>
      <h3>{{humanPhone(currentProject.fields.phone)}}</h3>
      {{#if currentProject.fields.description}}<p>{{currentProject.fields.description}}</p>{{/if}}
      {{#if currentSubmissions}}
      <p>This project has received {{currentSubmissions.length}} submissions.</p>
      {{/if}}
      {{#if !currentPrompts}}
        <Spinner/>
      {{else}}
        <div class="mb-3">
          {{#each currentPrompts as prompt, i}}
            <div class="row mt-3">
              <div class="reorder">
                <button on:click="up(i)">⬆️</button>
                {{#if i !== currentPrompts.length - 1}}<button on:click="down(i)">⬇️</button>{{/if}}
              </div>
              <h4 class="col-sm-6 text-left">
                {{#if prompt.fields.slug}}
                  {{prompt.fields.slug}}
                {{else}}
                  Prompt {{humanIndex(prompt.fields.index)}}
                {{/if}}
              </h4>
              <audio controls src="{{audioUrl(prompt)}}" class="col-sm-6"></audio>
            </div>
          {{/each}}
        </div>
        {{#if promptsChanged}}
          <button on:click="saveReorder()" class="btn btn-success">Save new prompt order</button>
        {{else}}
          <UploadPrompt projectId="{{currentProject.id}}" index="{{currentPrompts.length}}" on:refreshPrompts/>
          <div>
            {{#if currentPrompts.length < 2 || showTips}}
              <div class="alert alert-primary small text-left mt-3" transition:slide>
              <p>
                For phone calls, an automated voice after <em>only</em> the first prompt will briefly tell callers to leave a messsage at the beep and press the pound sign ("#") when they are done. The call will also stop recording and move to the next prompt if the caller is silent from more than 5 seconds.
              </p>
              <p>
                The last "prompt" in your list won't actually give callers a chance to respond with a recording. Instead, it should be used for a goodbye message (e.g. "Thanks for calling! Listen for your voice in next week's show."). So make sure you have at least 2 prompts to actually gather audio.
              </p>
              <p>
                Hover over the left side of the prompts to reorder them. Make sure to click "save" after you do this. Click on each prompt to see all the recordings gathered in response to it.
              </p>
            </div>
            {{else}}
              <button class="btn badge badge-warning" on:click="toggleTips()">Tips for adding new prompts</button>
            {{/if}}
          </div>
        {{/if}}
      {{/if}}
    </div>
  </div>
{{/if}}

<style>
  #project-info {
    max-width: 720px;
  }

  /*** reorder buttons ***/

  .reorder {
    visibility:hidden;
    position: absolute;
    left: -1em;
  }

  div:hover > .reorder {
    visibility: visible;
  }

  .reorder button {
    display: block;
    border: none;
    outline: none;
    background-color: transparent;
    cursor: pointer;
    font-size: 0.5em;
  }

  /* hides up arrow for first prompt */
  div:first-child > .reorder > button:first-child {
    visibility: hidden;
  }
</style>

<script>
  import { slide } from 'svelte-transitions';

  import { humanIndex, humanPhone } from './util';
  import Spinner from './Spinner.html';
  import UploadPrompt from './UploadPrompt.html';

  export default {
    components: { Spinner, UploadPrompt },
    transitions: { slide },
    computed: {
      name: currentProject => (currentProject ? currentProject.fields.name : ''),
    },
    helpers: {
      audioUrl: prompt => prompt.fields.audio[0].url,
      humanIndex,
      humanPhone,
    },
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        currentSubmissions: null,
        promptsChanged: false,
        showTips: false,
      };
    },
    methods: {
      up(i) {
        const currentPrompts = this.get('currentPrompts');
        [currentPrompts[i - 1], currentPrompts[i]] = [currentPrompts[i], currentPrompts[i - 1]];
        this.set({ currentPrompts, promptsChanged: true });
      },
      down(i) {
        const currentPrompts = this.get('currentPrompts');
        [currentPrompts[i + 1], currentPrompts[i]] = [currentPrompts[i], currentPrompts[i + 1]];
        this.set({ currentPrompts, promptsChanged: true });
      },
      saveReorder() {
        // Tell parent to find differences and update with PUT request
        this.fire('refreshPrompts', { reorderedPrompts: this.get('currentPrompts') });
        // Spinner until parent confirms save
        this.set({ currentPrompts: null, promptsChanged: false });
      },
      toggleTips() {
        this.set({ showTips: true });
      },
    },
  };
</script>
