<div>
  {{#if !currentSubmissions || !currentPrompts}}
    Loading submissions.
  {{else}}
    {{#each currentPrompts as prompt}}
      <h3>Submissions for prompt {{prompt.fields.index}}</h3>
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Caller</th>
            <th>Audio</th>
            <th>Transcript</th>
          </tr>
        </thead>
        <tbody>
          {{#each filterByPrompt(currentSubmissions, prompt.id) as submission}}
            <tr>
              <td>{{submission.fields.timestamp}}</td>
              <td>{{submission.fields.caller}}</td>
              <td><audio controls preload="metadata" src="{{submission.fields.audio}}"></audio></td>
              <td>
                {{#if submission.fields.transcript}}
                  {{submission.fields.transcript}}
                {{else}}
                  <button on:click="transcribe(submission.id)">Transcribe</button>
                {{/if}}
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    {{/each}}
  {{/if}}
</div>

<script>
  export default {
    data() {
      return {
        currentProject: null,
        currentPrompts: null,
        currentSubmissions: null,
      };
    },
    computed: {
      projectName: currentProject => currentProject.fields.name,
    },
    helpers: {
      filterByPrompt: (currentSubmissions, promptId) =>
        currentSubmissions.filter(sub => sub.fields.prompt[0] === promptId),
    },
    methods: {
      async transcribe(submissionId) {
        console.log(submissionId);
        await fetch(`/api/transcribe/${submissionId}`, {
          method: 'POST',
        });
        console.log('fetched');
        const submissions = this.get('currentSubmissions');
        for (let i = 0; i < submissions.length; i += 1) {
          if (submissions[i].id === submissionId) {
            submissions[i].transcript = 'Transcription in progress.';
            console.log(submissions);
            this.set({ currentSubmissions: submissions });
            return;
          }
        }
      },
    },
  };
</script>
